---
import Button from "@/components/ui/Button.astro";
import { ArrowRight, Search } from "@lucide/astro";
import Input from "./Input.astro";
import { applyStyles } from "@/utils/apply-styles";

export interface Props {
  placeholder?: string;
  buttonText?: string;
  class?: string;
  showDescription?: boolean;
}

const {
  placeholder = "0x1234567890abcdef...",
  buttonText = "Analyze Security",
  class: className = "",
  showDescription = true,
} = Astro.props;
---

<div class={`address-search-form ${className}`}>
  <form
    id="address-form"
    method="post"
    class={applyStyles(
      "mt-10 flex flex-col items-center justify-center gap-5 sm:flex-row sm:items-stretch",
      className,
    )}
  >
    <Input
      variant="outline"
      aria-label="Ethereum Address"
      class="md:!w-[567px]"
      id="security-checker-input"
      type="text"
      name="address"
      placeholder={"Enter your wallet address"}
      required
    />

    <Button
      id="security-checker-button"
      variant="secondary"
      type="submit"
      class="w-[168px]"
    >
      <span class="flex items-center gap-4">
        Analyze
        <ArrowRight />
      </span>
    </Button>
  </form>

  <div
    id="error-message"
    class="mt-4 hidden md:mx-auto md:max-w-[calc(567px+168px)]"
  >
    <div class="rounded-lg border border-red-300 bg-red-100 p-4">
      <p class="font-body text-red-700" id="error-text"></p>
    </div>
  </div>

  <div
    id="loading-message"
    class="mt-4 hidden md:mx-auto md:max-w-[calc(567px+168px)]"
  >
    <div class="rounded-lg border border-blue-300 bg-blue-100 p-4">
      <p class="font-body flex items-center gap-2 text-blue-700">
        <span
          class="h-4 w-4 animate-spin rounded-full border-2 border-blue-600 border-t-transparent"
        ></span>
        Analyzing address...
      </p>
    </div>
  </div>
</div>

<script>
  function initializeAddressForm() {
    const form = document.getElementById("address-form") as HTMLFormElement;
    const errorMessage = document.getElementById(
      "error-message",
    ) as HTMLElement;
    const errorText = document.getElementById("error-text") as HTMLElement;
    const loadingMessage = document.getElementById(
      "loading-message",
    ) as HTMLElement;
    const analyzeButton = document.getElementById(
      "analyze-button",
    ) as HTMLButtonElement;

    if (!form) return;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const address = (formData.get("address") as string)?.trim();

      // Hide previous messages
      errorMessage?.classList.add("hidden");
      loadingMessage?.classList.remove("hidden");
      if (analyzeButton) analyzeButton.disabled = true;

      try {
        // Validate Ethereum address format
        if (!address) {
          throw new Error("Please enter an Ethereum address");
        }

        if (!address.startsWith("0x")) {
          throw new Error('Ethereum address must start with "0x"');
        }

        if (address.length !== 42) {
          throw new Error(
            "Ethereum address must be exactly 42 characters long (0x + 40 hex characters)",
          );
        }

        const ethAddressRegex = /^0x[a-fA-F0-9]{40}$/;
        if (!ethAddressRegex.test(address)) {
          throw new Error(
            'Ethereum address contains invalid characters. Only 0-9 and a-f are allowed after "0x"',
          );
        }

        // Navigate to the security report page
        window.location.href = `/security-report/${address}`;
      } catch (error) {
        // Show error message
        loadingMessage?.classList.add("hidden");
        if (errorText) {
          errorText.textContent =
            error instanceof Error
              ? error.message
              : "An error occurred while processing your request";
        }
        errorMessage?.classList.remove("hidden");
        if (analyzeButton) analyzeButton.disabled = false;
      }
    });
  }

  // Initialize when DOM is loaded
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initializeAddressForm);
  } else {
    initializeAddressForm();
  }
</script>
